# 프리미엄 기능 마이그레이션 가이드

## 개요
기존 사용자들이 프리미엄 서비스를 원활하게 사용할 수 있도록 데이터 마이그레이션을 진행합니다.

## 마이그레이션 대상
1. **기존 사용자**: 프리미엄 필드가 없는 사용자 문서
2. **블랙리스트 데이터**: 기존 블랙리스트 정보 보존
3. **월간 카운트**: 모임 생성/참여 제한을 위한 카운트 시스템

## 마이그레이션 단계

### 1단계: 프리미엄 필드 추가
```bash
# 마이그레이션 스크립트 실행
node scripts/migratePremiumFields.js
```

**추가되는 필드:**
- `isPremium`: 프리미엄 구독 여부 (기본값: false)
- `subscriptionType`: 구독 타입 (기본값: null)
- `purchaseDate`: 구매일 (기본값: null)
- `transactionId`: 거래 ID (기본값: null)
- `originalTransactionId`: 원본 거래 ID (기본값: null)
- `expiresDate`: 만료일 (기본값: null)
- `isActive`: 활성 상태 (기본값: false)
- `blacklistCount`: 블랙리스트 수 (기본값: 0)
- `discountEligible`: 할인 자격 (기본값: false)
- `monthlyCounts`: 월간 카운트 (기본값: {})

### 2단계: 블랙리스트 카운트 동기화
기존 블랙리스트 데이터를 기반으로 `blacklistCount` 필드를 업데이트합니다.

### 3단계: 월간 카운트 초기화
매월 1일 자정에 실행할 스크립트로 모임 생성/참여 제한을 위한 카운트를 초기화합니다.

## 데이터 보존 정책

### 블랙리스트 데이터
- **현재**: 모든 사용자가 블랙리스트 사용 가능
- **전환 시**: 프리미엄 사용자만 사용 가능
- **기존 데이터**: 프리미엄 전환 시 자동으로 활성화
- **해제 시**: 기존 블랙리스트 데이터는 보존되지만 사용 불가

### 월간 카운트
- **무료 사용자**: 월 5개 제한
- **프리미엄 사용자**: 무제한
- **리셋 주기**: 매월 1일 자정

## 사용자 경험 고려사항

### 1. 혼란 방지
- 블랙리스트 화면에 "무료 제공 중, 추후 프리미엄 전환 예정" 안내 추가
- 프리미엄 화면에 간단한 2가지 기능 설명

### 2. 점진적 전환
- 현재: 블랙리스트 무료 제공
- 추후: 프리미엄 전용으로 변경
- 기존 사용자: 프리미엄 전환 시 기존 데이터 유지

### 3. 알림 시스템
- 제한 도달 시: "프리미엄 구독을 통해 무제한으로 생성해보세요!"
- 블랙리스트 초과 시: "최대 3명까지 등록 가능합니다."

## 실행 방법

### 개발 환경
```bash
# 1. Firebase Admin SDK 설정
# 2. 서비스 계정 키 파일 준비
# 3. 마이그레이션 스크립트 실행
node scripts/migratePremiumFields.js
```

### 프로덕션 환경
```bash
# 1. Firebase Admin SDK 설정
# 2. 서비스 계정 키 파일 준비
# 3. 백업 생성
# 4. 마이그레이션 실행
# 5. 결과 검증
```

## 주의사항

1. **백업 필수**: 마이그레이션 전 반드시 데이터 백업
2. **단계별 실행**: 한 번에 모든 사용자를 처리하지 말고 배치 단위로 실행
3. **검증**: 마이그레이션 후 데이터 무결성 확인
4. **롤백 계획**: 문제 발생 시 롤백 방법 준비

## 모니터링

### 마이그레이션 후 확인사항
- [ ] 모든 사용자 문서에 프리미엄 필드 추가됨
- [ ] 블랙리스트 카운트 정확히 동기화됨
- [ ] 월간 카운트 초기화됨
- [ ] 기존 블랙리스트 데이터 보존됨
- [ ] 앱 기능 정상 작동

### 지속적 모니터링
- 월간 카운트 리셋 스크립트 실행
- 프리미엄 구독 상태 동기화
- 블랙리스트 카운트 정확성 확인

## 문제 해결

### 일반적인 문제
1. **권한 오류**: Firebase Admin SDK 권한 확인
2. **배치 크기 초과**: 배치 크기 조정 (최대 500개)
3. **네트워크 오류**: 재시도 로직 구현

### 롤백 방법
1. 백업 데이터 복원
2. 프리미엄 필드 제거
3. 앱 버전 다운그레이드

## 연락처
문제 발생 시 개발팀에 문의하세요.
